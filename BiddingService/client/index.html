<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SignalR Client Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.5/signalr.min.js"></script>
  </head>

  <body>
    <div>
      <label for="bidderId">Bidder ID: </label>
      <input type="text" id="bidderId" placeholder="Enter Bidder ID" />

      <label for="auctionLotId">auctionLotId: </label>
      <input type="text" id="auctionLotId" placeholder="Enter auctionLotId" />

      <button id="joinAuctionLotButton">Join auction Lot</button>
      <hr />
      <hr />
      <hr />

      <label for="bidInput">Bidder ID: </label>
      <input type="number" id="bidInput" placeholder="Enter bid amount" />
      <button id="placeBidButton">Place bid</button>
    </div>
    <script>
      // Kết nối đến SignalR Hub
      const connection = new signalR.HubConnectionBuilder()
        .withUrl("http://localhost:5256/hub") // Địa chỉ của SignalR Hub
        .build();

      // Bắt đầu kết nối
      connection
        .start()
        .then(function () {
          console.log("Connected to SignalR hub");

          // Thêm sự kiện click cho button để gọi JoinauctionLotId
          document
            .getElementById("joinAuctionLotButton")
            .addEventListener("click", function () {
              // Lấy dữ liệu từ các input field
              const bidderId = parseInt(
                document.getElementById("bidderId").value,
                10
              );
              const auctionLotId = parseInt(
                document.getElementById("auctionLotId").value,
                10
              );

              // Gọi phương thức JoinauctionLotId từ phía client
              connection
                .invoke("JoinAuctionLot", {
                  BidderId: bidderId,
                  auctionLotId: auctionLotId,
                })
                .then(() => {
                  console.log(
                    `Joined auctionLotId ${auctionLotId} as bidder ${bidderId}`
                  );
                })
                .catch((err) => console.error(err));
            });

          document
            .getElementById("placeBidButton")
            .addEventListener("click", function () {
              const bidderId = parseInt(
                document.getElementById("bidderId").value,
                10
              );
              const auctionLotId = parseInt(
                document.getElementById("auctionLotId").value,
                10
              );
              const bidAmount = parseInt(
                document.getElementById("bidInput").value,
                10
              );

              connection
                .invoke("SendMessagePlaceBid", {
                  BidderId: bidderId,
                  auctionLotId: auctionLotId,
                  BidAmount: bidAmount,
                })
                .then(() => {
                  console.log(
                    `In ${auctionLotId}, bidder ${bidderId}: ${bidAmount}VND`
                  );
                })
                .catch((err) => console.error(err));
            });

          // Lắng nghe sự kiện khi nhận được bid hợp lệ từ server
          connection.on("ReceivePlaceBid", function (bidMessage) {
            console.log(bidMessage); // Log the full bidMessage object to check structure

            console.log(
              //   "may ne cu"
              `Received bid ${bidMessage.bidAmount}VND from bidder ${bidMessage.bidderId} in auctionLotId ${bidMessage.auctionLotId}`
            );
          });

          // Lắng nghe sự kiện khi bid không hợp lệ
          connection.on("BidFailed", function (message) {
            console.log("Bid failed: " + message);
          });
        })
        .catch(function (err) {
          return console.error(err.toString());
        });
    </script>
  </body>
</html>
